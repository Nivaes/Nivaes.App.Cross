name: CI Samples

on:
  push:
    branches-ignore:
    - 'release/**'
    paths-ignore:
    - '**/*.md'
  pull_request:
    types: [opened, synchronize, reopened] 
    paths-ignore:
    - '**/*.md'

jobs:
  build:

    runs-on: ubuntu-20.04

    steps:
    - name: Dump GitHub context
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: echo "$GITHUB_CONTEXT"

    - name: Checkout
      uses: actions/checkout@v2

    - name: Setup .NET Core 3.1.x
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 3.1.x

    - name: Setup .NET Core 5.0.x
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 5.0.x
        source-url: https://nuget.pkg.github.com/Nivaes/index.json
      env:
        NUGET_AUTH_TOKEN: ${{secrets.GITHUB_TOKEN}}

    - name: Setup .NET Core 6.0.x
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 6.0.100-preview.3.21202.5

    - name: Build.App.Cross.Sample
      run: dotnet build ./Samples/Nivaes.App.Cross.Sample/ --configuration Release

    - name: Build.App.Cross.Desktop.Sample
      run: dotnet build ./Samples/Nivaes.App.Cross.Desktop.Sample/ --configuration Release

    - name: Build.App.Cross.Mobile.Sample
      run: dotnet build ./Samples/Nivaes.App.Cross.Mobile.Sample/ --configuration Release

    - name: Build.App.Cross.Tv.Sample
      run: dotnet build ./Samples/Nivaes.App.Cross.Tv.Sample/ --configuration Release

    - name: Build.App.Cross.Watch.Sample
      run: dotnet build ./Samples/Nivaes.App.Cross.Watch.Sample/ --configuration Release

    #- name: Test
    #  run: dotnet test --configuration Release --no-build --verbosity normal

  build-Android:
    needs: build
    runs-on: windows-2019
    #runs-on: ubuntu-20.04

    steps:
    - name: Dump GitHub context
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: echo "$GITHUB_CONTEXT"

    - name: Checkout
      uses: actions/checkout@v2

    #- name: Setup .NET Core 3.1.x
    #  uses: actions/setup-dotnet@v1
    #  with:
    #    dotnet-version: 3.1.x

    #- name: Setup .NET Core 5.0.x
    #  uses: actions/setup-dotnet@v1
    #  with:
    #    dotnet-version: 5.0.x
    #    source-url: https://nuget.pkg.github.com/Nivaes/index.json
    #  env:
    #    NUGET_AUTH_TOKEN: ${{secrets.GITHUB_TOKEN}}

    #- name: Setup .NET Core 6.0.x
    #  uses: actions/setup-dotnet@v1
    #  with:
    #    dotnet-version: 6.0.100-preview.3.21202.5

    - name: Setup .NET Core 6.0.x
      run: |
        Invoke-WebRequest -Uri "https://dot.net/v1/dotnet-install.ps1" -OutFile dotnet-install.ps1
        .\dotnet-install.ps1 -Version 6.0.100-preview.3.21202.5 -InstallDir "$env:ProgramFiles\dotnet\" -Verbose
        dotnet --list-sdks

    - name: Install Android Workloads
      #env:
      #  ANDROIDWORKLOADS: ${{https://dl.internalx.com/vsts-devdiv/Xamarin.Android/public/net6/4451481/master/05bb8e0eae11ae6a73838b13cf91ee2433169dff/Microsoft.NET.Workload.Android.11.0.200.85.msi}}
      #  MACOSWORKLOADS: ${{https://bosstoragemirror.azureedge.net/wrench/main/f01fde5cd9a7ffffcdc8d241200c35988700fa00/4449408/package/Microsoft.NET.Workload.iOS.14.3.100-ci.main.1079.msi}}
      shell: pwsh
      run: |
        dotnet tool install --global boots
        boots https://dl.internalx.com/vsts-devdiv/Xamarin.Android/public/net6/4624420/6.0.1xx-preview3/7d6cd1cde4182d7db2cfc5d0b55364c972b6d34f/Microsoft.NET.Workload.Android.11.0.200.196.msi

    - name: Build Droid
      run: dotnet build ./Samples/Nivaes.App.Cross.Mobile.Droid.Sample/ --configuration Release

  build-MacOs:
    needs: build
    runs-on: macos-10.15

    steps:
    - name: Dump GitHub context
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: echo "$GITHUB_CONTEXT"

    - name: Checkout
      uses: actions/checkout@v2

    #- name: Setup .NET Core 3.1.x
    #  uses: actions/setup-dotnet@v1
    #  with:
    #    dotnet-version: 3.1.x

    #- name: Setup .NET Core 5.0.x
    #  uses: actions/setup-dotnet@v1
    #  with:
    #    dotnet-version: 5.0.x
    #    source-url: https://nuget.pkg.github.com/Nivaes/index.json
    #  env:
    #    NUGET_AUTH_TOKEN: ${{secrets.GITHUB_TOKEN}}

    #- name: Setup .NET Core 6.0.x
    #  uses: actions/setup-dotnet@v1
    #  with:
    #    dotnet-version: 6.0.100-preview.3.21202.5

    - name: Install .NET Core 6.0.x
      run: |
        export PATH="/usr/local/share/dotnet/:~/.dotnet/tools:$PATH" 
        curl -L https://raw.githubusercontent.com/dotnet/install-scripts/7a9d5dcab92cf131fc2d8977052f8c2c2d540e22/src/dotnet-install.sh > dotnet-install.sh 
        sh dotnet-install.sh --version 6.0.100-preview.3.21202.5 --install-dir $DOTNET_ROOT --verbose 
        dotnet --list-sdks
        echo "##vso[task.setvariable variable=PATH]$PATH"

    - name: Install iOS Workloads
      #env:
      #  ANDROIDWORKLOADS: ${{https://dl.internalx.com/vsts-devdiv/Xamarin.Android/public/net6/4451481/master/05bb8e0eae11ae6a73838b13cf91ee2433169dff/Microsoft.NET.Workload.Android-11.0.200-ci.master.136.pkg}}
      #  MACOSWORKLOADS: ${{https://bosstoragemirror.azureedge.net/wrench/main/f01fde5cd9a7ffffcdc8d241200c35988700fa00/4449408/package/notarized/Microsoft.iOS.Bundle.14.3.100-ci.main.1079.pkg}}
      run: |
        dotnet tool install --global boots
        boots https://bosstoragemirror.azureedge.net/wrench/6.0.1xx-preview3/f68d4d9c2a342daf9eaad364ccbe252e009d3901/4623693/package/notarized/Microsoft.iOS.Bundle.14.4.100-preview.3.1326.pkg
        boots https://bosstoragemirror.azureedge.net/wrench/6.0.1xx-preview3/f68d4d9c2a342daf9eaad364ccbe252e009d3901/4623693/package/notarized/Microsoft.macOS.Bundle.11.1.100-preview.3.1379.pkg
        boots https://bosstoragemirror.azureedge.net/wrench/6.0.1xx-preview3/f68d4d9c2a342daf9eaad364ccbe252e009d3901/4623693/package/notarized/Microsoft.MacCatalyst.Bundle.14.3.100-preview.3.471.pkg

    - name: Install Xcode 12.4
      run: sudo xcode-select -s /Applications/Xcode_12.4.app

    - name: configure vsmac xcode
      run: |
        set -x
        mkdir -p ~/Library/Preferences/Xamarin
        rm -f ~/Library/Preferences/Xamarin/Settings.plist
        /usr/libexec/PlistBuddy -c "add :AppleSdkRoot string $(dirname $(dirname $(xcode-select -p)))" ~/Library/Preferences/Xamarin/Settings.plist || true
        cat ~/Library/Preferences/Xamarin/Settings.plist || true

    #- name: setup-xamarin
    #  uses: maxim-lobanov/setup-xamarin@v1
    #  with:
    #    mono-version: latest
    #    xamarin-ios-version: latest
    #    xamarin-mac-version: latest 
    #    xcode-version: 12.x 

    #- name: Build App.Cross
    #  run: dotnet build ./Nivaes.App.Cross/ --framework netstandard2.1 --configuration Release

    #- name: Build iOS
    #  run: dotnet build ./Nivaes.App.Cross.iOS/ --configuration Release

    #- name: Build MacCatalyst
    #  run: dotnet build ./Nivaes.App.Cross.macCatalyst/ --configuration Release

    #- name: Build MacOS
    #  run: dotnet build ./Nivaes.App.Cross.macOS/ --configuration Release

    #- name: Build WatchOS
    #  run: dotnet build ./Nivaes.App.Cross.watchOS/ --configuration Release

    #- name: Build TvOS
    #  run: dotnet build ./Nivaes.App.Cross.tvOS/ --configuration Release

    - name: Build Droid
      run: dotnet build ./Samples/Nivaes.App.Cross.Mobile.iOS.Sample/ --configuration Release

  build-Windows:
    needs: build
    runs-on: windows-2019

    steps:
    - name: Dump GitHub context
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: echo "$GITHUB_CONTEXT"

    - name: Checkout
      uses: actions/checkout@v2

    - name: Setup .NET Core 3.1.x
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 3.1.x

    - name: Setup .NET Core 5.0.x
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 5.0.x
        source-url: https://nuget.pkg.github.com/Nivaes/index.json
      env:
        NUGET_AUTH_TOKEN: ${{secrets.GITHUB_TOKEN}}

    - name: Setup .NET Core 6.0.x
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 6.0.100-preview.3.21202.5

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.0.2

    #- name: Restore Windows
    #  run: dotnet restore ./Nivaes.App.Cross.Windows/

    - name: Build Windows
      run: msbuild ./Samples/Nivaes.App.Cross.Mobile.Windows.Sample/ /t:build
    #  run: dotnet build ./Samples/Nivaes.App.Cross.Mobile.Windows.Sample/ --configuration Release

    - name: Build Wpf
      run: dotnet build ./Samples/Nivaes.App.Cross.Desktop.Windows.Sample/ --configuration Release
